<!DOCTYPE html>
<html>
<head>
	
	<title>Budget Map</title>

	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css/style.css">
    
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.48.0/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.48.0/mapbox-gl.css' rel='stylesheet' />

    <link href="https://fonts.googleapis.com/css?family=Baloo+Tammudu|Raleway|Titillium+Web|Caveat" rel="stylesheet">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/v4-shims.css">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.4/dist/leaflet.css"
    integrity="sha512-puBpdR0798OZvTTbP4A8Ix/l+A4dHDD0DGqYW6RQ+9jxkRFclaxxQb/SJAWZfWAkuyeQUytO7+7N4QKrDh+drA=="
    crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.3.4/dist/leaflet.js"
    integrity="sha512-nMMmRyTVoLYqjP9hrbed9S+FzjZHW5gY1TWCHA5ckwXZBadntCNs8kEqAWdrb9O7rxbCaA4lKTIWjDXZxflOcA=="
    crossorigin=""></script>
    <script src="http://code.jquery.com/jquery-1.11.3.min.js"></script>

    <script src='https://npmcdn.com/@turf/turf/turf.min.js'></script>
</head>
<body>
    <h1>
        <i class="fa fa-plane" style="font: size 24px;"></i>
        &nbsp Trip to Lisbon 2018
    </h1>

    <div id="map" style="max-width: 1250px; height: 600px; margin:10px auto;"></div>
    
    <div class='map-overlay top'>
        <label id = 'spending'> Spending </label>
        <input id='slider' type='range' min='0' max='16' step='1' value='0' />
    </div>
    
    <script type="text/javascript" src="js/script.js"> </script>
    <script src="https://d3js.org/d3.v5.js"></script>
    
    <script>

        // get the geoJSON data
        var geojsondata;
        $.getJSON("https://dl.dropbox.com/s/axgc96qdg5g6rvp/lisbon18.geojson?dl=0", function(data) { geojsondata = data; });

        mapboxgl.accessToken = 'pk.eyJ1Ijoib2h5ZWFoYnJhdm8iLCJhIjoiY2psbXNqZmc0MTdhcDNycGIyenp6YTM5dSJ9.Zo0fukXCo-JW__NFIBQ7rw';
        var map = new mapboxgl.Map({
            container: 'map', // container id
            style: 'mapbox://styles/mapbox/light-v9',
            center: [1.2744140625, 46.92025531537451],// starting position
            zoom: 4 // starting zoom
        });

        // Add zoom and rotation controls to the map.
        var nav = new mapboxgl.NavigationControl();
        map.addControl(nav, 'bottom-right');

        // Add Points
        map.on('load', function() {
            map.addSource("lisbon18", {
                "type": "geojson",
                "data": geojsondata
            });

            map.addLayer({
                'id':'currentPos',
                'type': 'symbol',
                'source': 'lisbon18',
                'layout': {
                    'icon-image': 'marker-15',
                    'icon-allow-overlap': true,
                    'icon-offset': [0, 0]
                },
                'filter': ["==", "index", 0]
            });

            map.addLayer({
                'id':'points',
                'type': 'circle',
                'source': 'lisbon18',
                'paint': {
                    'circle-stroke-width': 1,
                    'circle-stroke-color': '#fff',
                    // circles change size as zoom level
                    'circle-radius': {
                        'base': 1.7,
                        'stops': [[5, 3], [22, 160]]
                    },
                    // circles are colored according to the categories
                    'circle-color': [
                        'match',
                        ['get', 'Category'],
                        'Transportation', '#0074D9', // blue
                        'Accommodation', '#4ABDAC',  // green
                        'Food', '#F7B733',   // yellow
                        'Sightseeing', '#FC4A1A',    // red
                        /* other */ '#DFDCE3'    // grey
                    ]
                }
            }, 'currentPos');
            
            // make an array for a route
            var routeArray = [ [0, 0], [1, 1]];
            // geojsondata.features.forEach(function(feature) {
            //     routeArray.push(feature.geometry.coordinates);                    
            // });

            var linestring = turf.lineString(routeArray);

            map.addLayer({
                'id':'route',
                'type':'line',
                'layout': {
                    'visibility': 'none'
                },
                'source': {
                    'type': 'geojson',
                    'data': linestring
                },
                'paint':{
                    'line-width': 3,
                    'line-color': '#96858f',
                    'line-opacity': 0.3
                }
            }, 'points');

        // add info box
        // https://www.mapbox.com/help/gl-dds-map-tutorial/#result-3
        map.on('click', function(e) {
            var features = map.queryRenderedFeatures(e.point, { layers: ['points'] });    
            
            if (!features.length) {
                return;
            }

            var feature = features[0];
            
            var payment = "fas fa-strikethrough"
            if(feature.properties['Payment'] == "Card")
                payment = "fas fa-credit-card"
            else if(feature.properties['Payment'] == "Cash")
                payment = "fas fa-money-bill"


            var popup = new mapboxgl.Popup()
            .setLngLat(feature.geometry.coordinates)
            .setHTML(
                '<div id=\'popup\' class=\'popup\' style=\'z-index: 10;\'>'
                    + '<h5>' + feature.properties['Title'] + '</h5>'
                    + '<h6>' 
                        + '<i class="fas fa-euro-sign" style="font: size 10px;"></i>' + '&nbsp&nbsp' + feature.properties['Amount'] + '&nbsp&nbsp&nbsp'
                        + '<i class="' + payment + '" style="font: size 12px; color: #C5C6F3;"></i>' + '</br>'
                        + '<i class="fas fa-map-marker-alt" style="font: size 10px;"></i>' + '&nbsp&nbsp' + feature.properties['Location'] + '<br>'
                        + '<i class="fas fa-clock" style="font: size 10px;"></i>' + '&nbsp&nbsp' + feature.properties['Day'] + '&nbsp&nbsp' + feature.properties['Time'] + '<br>'
                    + '</h6>'
                    + '<div class="memo">' + feature.properties['Memo'] + '</div>'
                + '</div>'
            ).addTo(map);
        
        });

        // change cursor when you hover over the point
        map.on('mousemove', function(e) {
            var features = map.queryRenderedFeatures(e.point, { layers: ['points'] });
            map.getCanvas().style.cursor = features.length ? 'pointer' : '';
        });

        var slider = document.getElementById('slider');
        var sliderValue = document.getElementById('spending');

        
        slider.addEventListener('input', function(e) {
            
            var step = parseInt(e.target.value);

            //map.setFilter('points', ['==']);
            // var features = map.queryRenderedFeatures({ layers: ['points'] });    
            // if (!features.length) {
            //     return;
            // }
            // var feature = features[0];

            // move the current marker on the map
            map.setFilter("currentPos", ["==", "index", step]);
            

            // show the route progress
            linestring.geometry.coordinates = [];  // initailize the route
            geojsondata.features.forEach(function(feature) {
                if(feature.properties['index'] <= step) {
                    linestring.geometry.coordinates.push(feature.geometry.coordinates);
                }
            });
            map.getSource('route').setData(linestring);
            map.setLayoutProperty('route', 'visibility', 'visible');
            //sliderValue.textContent = feature.properties['Title'];
        });
    });
        
    </script>

    </body>
</html>
