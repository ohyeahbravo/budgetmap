<!DOCTYPE html>
<html>
<head>
	
	<title>Budget Map</title>

	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css/style.css">
    
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.48.0/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.48.0/mapbox-gl.css' rel='stylesheet' />

    <link href="https://fonts.googleapis.com/css?family=Baloo+Tammudu|Raleway|Titillium+Web|Caveat" rel="stylesheet">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/v4-shims.css">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.4/dist/leaflet.css"
    integrity="sha512-puBpdR0798OZvTTbP4A8Ix/l+A4dHDD0DGqYW6RQ+9jxkRFclaxxQb/SJAWZfWAkuyeQUytO7+7N4QKrDh+drA=="
    crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.3.4/dist/leaflet.js"
    integrity="sha512-nMMmRyTVoLYqjP9hrbed9S+FzjZHW5gY1TWCHA5ckwXZBadntCNs8kEqAWdrb9O7rxbCaA4lKTIWjDXZxflOcA=="
    crossorigin=""></script>
    <script src="http://code.jquery.com/jquery-1.11.3.min.js"></script>

    <script src='https://npmcdn.com/@turf/turf/turf.min.js'></script>

    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

</head>
<body>
    <h1>
        <i class="fa fa-plane" style="font: size 24px;"></i>
        &nbsp Trip to Lisbon 2018
    </h1>

    <div id="map"></div>

    <div class='chart-box'>
        <label id = 'amount'>€ 0</label>
        <div id="barChart"></div>
    </div>
    
    <div class='map-overlay top'>
        <div class='map-overlay-inner'>
            <label id = 'date' style = 'margin-bottom: 2px; color: grey; font-size: 12px'> Date </label>
            <label id = 'time'> Time </label>
            <input id='slider' type='range' min='0' max='16' step='1' value='0' class="slider" />
        </div>
    </div>
    
    <script type="text/javascript" src="js/script.js"> </script>
    <script src="https://d3js.org/d3.v5.js"></script>
    
    <script>

        const fixFloatingPoint = val => Number.parseFloat(val.toFixed(2));
        var win_width = (window.innerWidth > 0) ? window.innerWidth : screen.width;
        var win_height = (window.innerHeight > 0) ? window.innerHeight : screen.height;

        // get the geoJSON data
        var geojsondata;
        $.getJSON("https://dl.dropbox.com/s/axgc96qdg5g6rvp/lisbon18.geojson?dl=0", function(data) { geojsondata = data; });

        mapboxgl.accessToken = 'pk.eyJ1Ijoib2h5ZWFoYnJhdm8iLCJhIjoiY2psbXNqZmc0MTdhcDNycGIyenp6YTM5dSJ9.Zo0fukXCo-JW__NFIBQ7rw';
        var map = new mapboxgl.Map({
            container: 'map', // container id
            style: 'mapbox://styles/mapbox/light-v9',
            center: [-0.5, 46.94],// starting position
            zoom: 4.1 // starting zoom
        });

        // Add zoom and rotation controls to the map.
        var nav = new mapboxgl.NavigationControl();
        map.addControl(nav, 'bottom-right');

        // Add Points
        map.on('load', function() {
            map.addSource("lisbon18", {
                "type": "geojson",
                "data": geojsondata
            });

            map.addLayer({
                'id':'points',
                'type': 'circle',
                'source': 'lisbon18',
                'paint': {
                    'circle-stroke-width': 1,
                    'circle-stroke-color': '#fff',
                    // circles change size as zoom level
                    'circle-radius': {
                        'base': 1.7,
                        'stops': [[5, 3], [22, 160]]
                    },
                    // circles are colored according to the categories
                    'circle-color': [
                        'match',
                        ['get', 'Category'],
                        'Transportation', '#4F9CE0', // blue
                        'Accommodation', '#64C4B6',  // green
                        'Food', '#FAC150',   // yellow
                        'Sightseeing', '#FA5D32',    // red
                        /* other */ '#DFDCE3'    // grey
                    ]
                }
            });

            map.addLayer({
                'id':'currentPos',
                'type': 'circle',
                'source': 'lisbon18',
                'paint': {
                    'circle-stroke-width': 0,
                    'circle-radius': {
                        'base': 14,
                        'stops': [[5, 16], [22, 200]]
                    },
                    'circle-color': '#000',
                    'circle-opacity': 0.3
                },
                'filter': ["==", "index", 0]
            }, 'points');
            
            // make an array for a route because empty array wouldn't work
            var routeArray = [ [0, 0], [1, 1]];

            var linestring = turf.lineString(routeArray);
            var linestringYet = turf.lineString(routeArray);

            map.addLayer({
                'id':'route',
                'type':'line',
                'layout': {
                    'visibility': 'none'
                },
                'source': {
                    'type': 'geojson',
                    'data': linestring
                },
                'paint':{
                    'line-width': 3,
                    'line-color': '#96858f',
                    'line-opacity': 0.7
                }
            }, 'points');

            // left route
            map.addLayer({
                'id':'routeYet',
                'type':'line',
                'layout': {
                    'visibility': 'none'
                },
                'source': {
                    'type': 'geojson',
                    'data': linestringYet
                },
                'paint':{
                    'line-width': 3,
                    'line-color': '#96858f',
                    'line-opacity': 0.3,
                    'line-dasharray': [1, 1]
                }
            }, 'points');
            
            // title labels for markers
            map.addLayer({
                'id': 'titles',
                'type': 'symbol',
                'source': 'lisbon18',
                'layout': {
                    'text-field': ['get', 'Title'],
                    'text-font': ["Open Sans Bold", "Arial Unicode MS Bold"],
                    'text-size': 19 ,
                    'text-letter-spacing': 0.05,
                    'text-offset': [0, -2],
                    'visibility': 'none',
                    'text-max-width': Infinity
                },
                'paint': {
                    'text-color': '#202',
                    'text-halo-color': '#fff',
                    'text-halo-width': 2
                }
            });

            // amount labels for markers
            map.addLayer({
                'id': 'amounts',
                'type': 'symbol',
                'source': 'lisbon18',
                'layout': {
                    'text-field': "",
                    'text-font': ["Open Sans Bold", "Arial Unicode MS Bold"],
                    'text-size': 17 ,
                    'text-letter-spacing': 0.05,
                    'text-offset': [0, -4]
                },
                'paint': {
                    'text-color': [
                        'match',
                        ['get', 'Category'],
                        'Transportation', '#4F9CE0', // blue
                        'Accommodation', '#64C4B6',  // green
                        'Food', '#FAC150',   // yellow
                        'Sightseeing', '#FA5D32',    // red
                        /* other */ '#DFDCE3'    // grey
                    ],
                    'text-halo-color': '#fff',
                    'text-halo-width': 2
                }
            });

        var xData = [];
        var yData = [0,0,0,0];
        var textData = [0, 0, 0, 0];
        var total = [0,0,0,0];
        
        geojsondata.features.forEach(function(feature) {
            var string = feature.properties['Category'];
            if(!xData.includes(string)) {
                xData.push(feature.properties['Category']);
            }
        });
        
        geojsondata.features.forEach(function(feature) {
            var string = feature.properties['Category'];
            var amount = feature.properties['Amount'];
            
            if(string == 'Transportation') {
                total[0] = fixFloatingPoint(total[0] - amount);
            }
            if(string == 'Accommodation') {
                total[1] = fixFloatingPoint(total[1] - amount);
            }
            if(string == 'Food') {
                total[2] = fixFloatingPoint(total[2] - amount);
            }
            if(string == 'Sightseeing') {
                total[3] = fixFloatingPoint(total[3] - amount);
            }
        });

        var chartData1 = {
            textposition: "outside",
            text: textData,
            textfont: {
                family: 'Caveat', 
                size: 12,
                color: ['#4F9CE0', '#64C4B6', '#FAC150', '#FA5D32']
            },
            type: 'bar',
            hoverinfo: 'none',
            x: xData,
            y: yData,
            orientation: 'v',
            marker: {
                color:["#4F9CE0", '#64C4B6', '#FAC150', '#FA5D32']
            }
        };
        
        var backchart = [total[0], total[1], total[2], total[3]];
        var chartData2 = {
            textposition: "outside",
            text: textData,
            textfont: {
                family: 'Caveat', 
                size: 12,
                color: ['#4F9CE0', '#64C4B6', '#FAC150', '#FA5D32']
            },
            type: 'bar',
            hoverinfo: 'none',
            x: xData,
            y: backchart,
            orientation: 'v',
            marker: {
                color:["#000", '#000', '#000', '#000'],
                opacity: 0.2
            }
        };

        var chartData = [chartData1, chartData2]

        var layout= {
            width: win_width * 0.15,
            height: win_height * 0.5,
            margin: {
                l: 0,
                r: 0,
                b: 0,
                t: 0,
                pad: 0
            },
            paper_bgcolor: 'transparent',
            plot_bgcolor: 'transparent',
            barmode:'stack',
            showlegend: false,
            opacity: 0.7,            
            xaxis: {
                visible: false
            },
            yaxis: {
                visible: false
            }
        };
        Plotly.newPlot('barChart', chartData, layout);
        
        // add info box
        // https://www.mapbox.com/help/gl-dds-map-tutorial/#result-3
        map.on('click', function(e) {
            var features = map.queryRenderedFeatures(e.point, { layers: ['points'] });    
            
            if (!features.length) {
                return;
            }
            
            var feature = features[0];
            
            var payment = "fas fa-strikethrough"
            if(feature.properties['Payment'] == "Card")
                payment = "fas fa-credit-card"
            else if(feature.properties['Payment'] == "Cash")
                payment = "fas fa-money-bill"

            var popup = new mapboxgl.Popup()
            .setLngLat(feature.geometry.coordinates)
            .setHTML(
                '<div id=\'popup\' class=\'popup\' style=\'z-index: 10;\'>'
                    + '<h5>' + feature.properties['Title'] + '</h5>'
                    + '<h6>' 
                        + '<i class="fas fa-euro-sign" style="font: size 10px;"></i>' + '&nbsp&nbsp' + feature.properties['Amount'] + '&nbsp&nbsp&nbsp'
                        + '<i class="' + payment + '" style="font: size 12px; color: #C5C6F3;"></i>' + '</br>'
                        + '<i class="fas fa-map-marker-alt" style="font: size 10px;"></i>' + '&nbsp&nbsp' + feature.properties['Location'] + '<br>'
                        + '<i class="fas fa-clock" style="font: size 10px;"></i>' + '&nbsp&nbsp' + feature.properties['Day'] + '&nbsp&nbsp' + feature.properties['Time'] + '<br>'
                    + '</h6>'
                    + '<div class="memo">' + feature.properties['Memo'] + '</div>'
                + '</div>'
            ).addTo(map);
        
        });

        // change cursor when you hover over the point
        map.on('mousemove', function(e) {
            var features = map.queryRenderedFeatures(e.point, { layers: ['points'] });
            map.getCanvas().style.cursor = features.length ? 'pointer' : '';
        });

        var slider = document.getElementById('slider');
        
        slider.addEventListener('input', function(e) {
            
            var step = parseInt(e.target.value);
            var match;

            // show the route progress
            linestring.geometry.coordinates = [];  // initailize the route
            geojsondata.features.forEach(function(feature) {
                if(feature.properties['index'] <= step) {
                    linestring.geometry.coordinates.push(feature.geometry.coordinates);
                }
                if(feature.properties['index'] == step) {
                    match = feature;
                }
            });

            linestringYet.geometry.coordinates = [];  // initailize the route
            if(step > 0) {
                geojsondata.features.forEach(function(feature) {
                    if(feature.properties['index'] >= step) {
                        linestringYet.geometry.coordinates.push(feature.geometry.coordinates);
                    }
                });
            }
            
            if(step > 0) {
                document.getElementById('date').textContent = match.properties['Day'];
                document.getElementById('time').textContent = match.properties['Time'];
                var amount = match.properties['Amount'].toString() + " €";
                map.setLayoutProperty('amounts', 'text-field', amount);
            } else {            
                document.getElementById('date').textContent = 'Date';
                document.getElementById('time').textContent = 'Time';
            }

            map.getSource('route').setData(linestring);
            map.getSource('routeYet').setData(linestringYet);
            map.setLayoutProperty('route', 'visibility', 'visible');
            map.setLayoutProperty('routeYet', 'visibility', 'visible');
            
            map.setLayoutProperty('titles', 'visibility', 'visible');
            map.setFilter("currentPos", ["==", "index", step]);
            map.setFilter('titles',  ["==", "index", step]);
            map.setFilter('amounts',  ["==", "index", step]);

            // Update Zoom
            var zoomcenter;
            if (step > 0) {
                zoomcenter = match.geometry.coordinates;
            }
            var zoomlevel = 14;
            if(step == 0) {
                zoomcenter = [-0.5, 46.94];
                zoomlevel = 4.1;
            } else if(step == 1) {
                zoomlevel = 7;         
            } else if (step == 2) {
                zoomlevel = 12;
            } else if (step == 13 || step == 14) {
                zoomcenter = [-9.393793344497679, 38.79629789297362];
                zoomlevel = 16;
            } else if (step != 6 && step != 16) {
                zoomcenter = [-9.141, 38.7125];
            }
            map.flyTo({center: zoomcenter, zoom: zoomlevel});

            // Update Chart
            yData.fill(0);
            textData.fill(0);
            backchart = [total[0], total[1], total[2], total[3]];

            geojsondata.features.forEach(function(feature) {
                if(feature.properties['index'] <= step) {
                    var string = feature.properties['Category'];
                    var amount = feature.properties['Amount'];
                    if(string == 'Transportation') {
                        yData[0] = fixFloatingPoint(yData[0] - amount);
                        textData[0] = fixFloatingPoint(textData[0] + amount);
                        backchart[0] = fixFloatingPoint(total[0] - yData[0]);
                    } else if(string == 'Accommodation') {
                        yData[1] = fixFloatingPoint(yData[1] - amount);
                        textData[1] = fixFloatingPoint(textData[1] + amount);
                        backchart[1] = fixFloatingPoint(total[1] - yData[1]);
                    }else if(string == 'Food') {
                        yData[2] = fixFloatingPoint(yData[2] - amount);
                        textData[2] = fixFloatingPoint(textData[2] + amount);
                        backchart[2] = fixFloatingPoint(total[2] - yData[2]);
                    }else {
                        yData[3] = fixFloatingPoint(yData[3] - amount);
                        textData[3] = fixFloatingPoint(textData[3] + amount);
                        backchart[3] = fixFloatingPoint(total[3] - yData[3]);
                    }
                }
            });

            document.getElementById('amount').textContent = '€ ' + fixFloatingPoint(textData[0] + textData[1] + textData[2] + textData[3]).toString();
            if(step == 0)
                document.getElementById('amount').textContent = '€ ' + '0';
            Plotly.restyle('barChart', 'y', [yData, backchart, textData]);
         });
    });
        
    </script>

    </body>
</html>
